---
- name: Manage SDP Cloud Requests
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - credentials.yml

  tasks:
    - name: Create a new Request
      manageengine.sdp_cloud.write_request:
        domain: "{{ domain }}"
        portal_name: "{{ portal_name }}"
        client_id: "{{ client_id }}"
        client_secret: "{{ client_secret }}"
        refresh_token: "{{ refresh_token }}"
        dc: "{{ dc }}"
        payload:
          subject: "Test Request from Ansible"
          description: "This is a test request."
          status: "Open"
          requester:
            name: "Administrator"
      register: new_request

    - name: Display New Request ID
      debug:
        msg: "Created Request ID: {{ new_request.response.request.id }}"

    - name: Update the Request
      manageengine.sdp_cloud.write_request:
        domain: "{{ domain }}"
        portal_name: "{{ portal_name }}"
        client_id: "{{ client_id }}"
        client_secret: "{{ client_secret }}"
        refresh_token: "{{ refresh_token }}"
        dc: "{{ dc }}"
        parent_id: "{{ new_request.response.request.id }}"
        payload:
          priority: "High"
      register: update_response

    - name: Get Request Details
      manageengine.sdp_cloud.read_request:
        domain: "{{ domain }}"
        portal_name: "{{ portal_name }}"
        client_id: "{{ client_id }}"
        client_secret: "{{ client_secret }}"
        refresh_token: "{{ refresh_token }}"
        dc: "{{ dc }}"
        parent_id: "{{ new_request.response.request.id }}"
      register: request_details

    - name: List Requests
      manageengine.sdp_cloud.read_request:
        domain: "{{ domain }}"
        portal_name: "{{ portal_name }}"
        client_id: "{{ client_id }}"
        client_secret: "{{ client_secret }}"
        refresh_token: "{{ refresh_token }}"
        dc: "{{ dc }}"
        payload:
          row_count: 5
      register: request_list
